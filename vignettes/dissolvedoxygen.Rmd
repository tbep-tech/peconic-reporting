---
title: "Dissolved Oxygen"
csl: stylefile.csl
bibliography: refs.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dissolved Oxygen}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, message = F, warning = F}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", message = F, warning = F, fig.align = 'center')

library(pepreporting)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(patchwork)

data(dodat)

mptyps <- c("CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", "Esri.WorldImagery", "OpenTopoMap")
```

This document describes a potential proof of concept for summarizing and reporting dissolved oxygen (DO) data for the Peconic Estuary.  Two continuous USGS monitoring stations collect DO data at locations in or near the Peconic Estuary.  The `dodat` data object includes sample data from these stations.  This dataset was obtained using the USGS dataRetrieval R package as follows:

```{r, eval = F}
library(dataRetrieval)

# get DO data from USGS stations
# 01304562 is Peconic River, 01304200 is Orient Harbor
# downloaded data are in UTC
# for cd column, USGS daily value qualification codes are often “A” (approved for publication) or “P” (provisional data subject to revision)
# above is from vignette https://cran.r-project.org/web/packages/dataRetrieval/vignettes/dataRetrieval.html
# takes a few minutes to dl
dodat <- readNWISuv(siteNumbers = c('01304562', '01304200'), parameterCd = '00300', startDate = '2013-01-01', endDate = '2020-12-31') %>%
  select(site = site_no, DateTime = dateTime, do_mgl = X_00300_00000) %>%
  mutate(DateTime = with_tz(DateTime, tzone = 'America/Jamaica'))
```
```{r}
head(dodat)
```

A plot of the raw data: 

```{r, fig.height = 8, fig.width = 8}
ggplot(dodat, aes(x = DateTime, y = do_mgl)) + 
  geom_line() + 
  geom_hline(yintercept = 4.8, linetype = 'dashed', colour = 'red') + 
  geom_hline(yintercept = 3, linetype = 'dashed', colour = 'red') +
  facet_wrap(~site, ncol = 1) +
  theme_minimal() + 
  labs(
    y = 'Dissolved oxygen (mg/L)', 
    x = NULL, 
    title = 'Dissolved oxygen time series at Orient Harbor (01304200) and Peconic River (01304562)', 
    subtitle = 'Dashed lines are chronic and acute threhsolds (4.8, 3 mg/L)'
  )
```

Dissolved oxygen data typically show daily and and seasonal variation.  The continuous data requires considerable summary to present the data in an easily interpretable format for management decisions and to present the data in a way that expresses condition.  For both, acute (3 mg/L) and chronic (4.8 mg/L) dissolved oxygen thresholds can be applied to summarize the data in different ways.  

Further, the impact of low dissolved oxygen concentrations can vary depending on both magnitude and duration of hypoxia/anoxia.  As such, condition assessment could also consider how often concentrations fall below a thresholds and for how long. The assessments below speak to both of these needs.

First, the data are summarized from the continuous (~6 minute observations) to daily averages and summaries.

```{r}
# 3 mg/l is acute, 4.8 mg/l is chronic
dlysum <- dodat %>% 
  mutate(
    Date = as.Date(DateTime)
  ) %>% 
  group_by(Date) %>% 
  summarise(
    acute = ifelse(any(do_mgl < 3), 1, 0), 
    chronic = ifelse(any(do_mgl < 4.8), 1, 0), 
    do_mgl = mean(do_mgl), 
    .groups = 'drop'
  ) 
dlysum
```

Columns for acute and chronic indicate if DO concentrations were below the respective threshold at any point during each day. To address the duration of exposure to undersatured conditions, a cumulative tally of the number of days at which dissolved oxygen fell below is threshold is also calculated.  These are present in the `acute_cumsum` and `acute_chronicsum` columns.

```{r}
dlysum <- dlysum %>% 
  group_by(grp = cumsum(acute == 0), yr = year(Date), mo = month(Date)) %>% 
  mutate(
    acute_cumsum = cumsum(acute)
  ) %>% 
  ungroup %>% 
  group_by(grp = cumsum(chronic == 0), yr, mo) %>% 
  mutate(
    chronic_cumsum = cumsum(chronic)
  ) %>% 
  select(-grp)
dlysum
```

The daily data provides the basis for summarizing seasonal information by month.  Summarizing by month distills in the information into an easily digestible format for plotting.  

```{r}
mosum <- dlysum %>% 
  group_by(
    yr = year(Date), 
    mo = month(Date, label = T, abbr = T)
  ) %>% 
  summarise(
    do_mgl = mean(do_mgl), 
    acute = mean(acute), 
    acute_cumsum = max(acute_cumsum), 
    chronic = mean(chronic), 
    chronic_cumsum = max(chronic_cumsum), 
    .groups = 'drop'
  )
mosum
```

There are several ways the data were summarized:

1) `acute`: The proportion of days in a month when concentrations in a given day fell below 3 mg/L
1) `chronic`: The proportion of days in a month when concentrations in a given day fell below 4.8 mg/L
1) `acute_cumsum`: The maximum number of sequential days in a month when concentrations in a given day fell below 3 mg/L
1) `chronic_cumsum`: The average number of sequential days in a month when concentrations in a given day fell below 4.8 mg/L

The first two item address only the number of times hypoxia conditions occurred, whereas the last two items address both the number of instances and duration of hypoxia. 

The first two plot show the first two summaries.

```{r, fig.height = 6, fig.width = 8}
ylims <- c(2013, 2020)
pthm <- theme_bw() + 
  theme(
    axis.title = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    legend.title = element_blank()
  )

p1 <- ggplot(mosum, aes(x = mo, y = yr, fill = acute)) + 
  geom_tile(colour = 'black') + 
  scale_x_discrete(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(ylims[1], ylims[2])) + 
  scale_fill_gradient2(low = 'green', mid = 'yellow', high = 'red', midpoint = 0.5) +
  pthm +
  labs(
    subtitle = '(a) The proportion of days each month when concentrations in a given day fell below 3 mg/L'
  )
  
p2 <- ggplot(mosum, aes(x = mo, y = yr, fill = chronic)) + 
  geom_tile(colour = 'black') + 
  scale_x_discrete(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(ylims[1], ylims[2])) + 
  scale_fill_gradient2(low = 'green', mid = 'yellow', high = 'red', midpoint = 0.5) +
  pthm +
  labs(
    subtitle = '(b) The proportion of days each month when concentrations in a given day fell below 4.8 mg/L'
  )

p1 + p2 + plot_layout(ncol = 1)
```

The next two plots show the third and fourth summaries that address severity and duration of hypoxia.

```{r, fig.height = 6, fig.width = 8}
p1 <- ggplot(mosum, aes(x = mo, y = yr, fill = acute_cumsum)) + 
  geom_tile(colour = 'black') + 
  scale_x_discrete(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(ylims[1], ylims[2])) + 
  scale_fill_gradient2(low = 'green', mid = 'yellow', high = 'red', midpoint = 15) +
  pthm +
  labs(
    subtitle = '(a) The maximum number of sequential days in a month when concentrations in a given day fell below 3 mg/L'
  )
  
p2 <- ggplot(mosum, aes(x = mo, y = yr, fill = chronic_cumsum)) + 
  geom_tile(colour = 'black') + 
  scale_x_discrete(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(ylims[1], ylims[2])) + 
  scale_fill_gradient2(low = 'green', mid = 'yellow', high = 'red', midpoint = 15) +
  pthm +
  labs(
    subtitle = '(b) The maximum number of sequential days in a month when concentrations in a given day fell below 4.8 mg/L'
  )

p1 + p2 + plot_layout(ncol = 1)
```

Plotting the results provides insights into hypoxia patterns at the site depending on how under-saturated conditions were summarized.

